name: Deploy Frontend

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VDS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VDS_HOST }}
          username: root
          key: ${{ secrets.VDS_SSH_KEY }}
          script: |
            cd /opt/biletlink
            
            echo "üîÑ Starting Deployment for Frontend..."
            
            # 1. Pull latest code
            if [ -d "BiletLink-Frontend" ]; then
              cd BiletLink-Frontend
              git pull origin main
              cd ..
            else
              git clone https://github.com/BiletLink/BiletLink-Frontend.git
            fi
            
            # 2. Build new image (Zero-downtime phase)
            echo "üèóÔ∏è Building new image..."
            docker compose build frontend
            
            # 3. Backup current image for Rollback (assuming image name is biletlink-frontend based on project)
            # Find the actual image name used by compose service
            IMAGE_NAME=$(docker compose images -q frontend | xargs docker inspect --format='{{.RepoTags}}' | tr -d '[]' | awk '{print $1}')
            if [ -z "$IMAGE_NAME" ]; then IMAGE_NAME="biletlink-frontend"; fi
            
            echo "üíæ Backing up current image ($IMAGE_NAME)..."
            if docker image inspect $IMAGE_NAME > /dev/null 2>&1; then
                docker tag $IMAGE_NAME ${IMAGE_NAME}:backup
            fi

            # 4. Deploy (Short downtime)
            echo "üöÄ Deploying new container..."
            docker compose up -d --no-deps --force-recreate frontend
            
            # 5. Health Check & Rollback Strategy
            echo "Checking system health..."
            HEALTHY=false
            for i in {1..12}; do # Wait up to 60s
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' biletlink-frontend 2>/dev/null)
              echo "Attempt $i: Status is $STATUS"
              if [ "$STATUS" = "healthy" ]; then
                HEALTHY=true
                break
              fi
              sleep 5
            done
            
            if [ "$HEALTHY" = "true" ]; then
              echo "‚úÖ Deployment Successful! Frontend is healthy."
              exit 0
            else
              echo "‚ùå Deployment Failed! Health check status: $STATUS"
              echo "üîÑ Initiating ROLLBACK..."
              
              if docker image inspect ${IMAGE_NAME}:backup > /dev/null 2>&1; then
                # Restore backup
                docker tag ${IMAGE_NAME}:backup $IMAGE_NAME
                # Redeploy old image
                docker compose up -d --no-deps --force-recreate frontend
                echo "‚úÖ Rollback completed. System restored to previous version."
              else
                echo "‚ö†Ô∏è Rollback failed: No backup image found."
              fi
              
              echo "Logs from failed container:"
              docker compose logs frontend --tail=50
              exit 1
            fi
